# Data Manifest

This document provides a central inventory of all data sources, configuration files, and data pipelines used in the Citizen Budget Lab application.

## 1. Core Budget & Policy Data

### 1.1. LEGO Pieces (Budget Building Blocks)

*   **Purpose:** Defines the granular, user-facing "pieces" for both expenditures and revenues. This is the foundational layer for the budget builder. Each piece has a human-readable label, a description, and a mapping to official economic classifications.
*   **Source File:** `data/lego_pieces.json`
*   **Status:** **Exists and is well-populated.** Contains over 30 expenditure and 15 revenue pieces.
*   **Pipeline:** This file is a primary input for the `lego` cache warmer (`services/api/cache_warm.py`) which uses the mappings to fetch baseline amounts from Eurostat.

### 1.2. LEGO Baseline (Budget Data)

*   **Purpose:** Provides the actual monetary values for a given year for all LEGO pieces. This is the data that populates the treemap and all budget displays.
*   **Source File:** `data/cache/lego_baseline_{YEAR}.json` (e.g., `lego_baseline_2025.json`)
*   **Status:** **Snapshots refreshed.** Eurostat-driven caches regenerated for 2026 on **2025-09-22**; **2026 baseline manually updated on 2025-12-30** to reflect the official adopted budget (PLF/PLFSS 2026).
*   **Pipeline:** Generated by `make warm-all YEAR=<year>` which executes the `lego` command in `services/api/cache_warm.py`. This script fetches data from Eurostat's SDMX API based on the mappings in `lego_pieces.json`. When the warehouse is enabled, API endpoints prefer warehouse models (`fct_lego_baseline`, `dim_lego_pieces`) for LEGO queries; otherwise the warmed JSON snapshot is used.

### 1.3. Policy Levers (Reform Catalog)
*   **Purpose:** Defines the list of concrete, named policy reforms available in the "Policy Workshop". Each lever has a fixed, pre-estimated budgetary impact and rich metadata.
*   **Source File:** `data/policy_levers.yaml`
*   **Schema:** `schemas/policy_levers.schema.json`
*   **Fields:**
    *   `mission_mapping`: (Required) Explicit dictionary mapping PLF mission codes to weights.
    *   `multi_year_impact`: Optional object mapping years (2026-2030) to impact values (EUR).
    *   `pushbacks`: Array of objects describing political/social implementation risks (type, description, source).
*   **Status:** **Exists and is populated.** Updated on **2025-12-30** with 38 new major amendments; rich metadata and administrative harmonization completed on **2026-01-02**.
*   **Pipeline:** Loaded by `services/api/policy_catalog.py`. Precomputed snapshots generated via `tools/build_snapshot.py` include this metadata for UI performance.

### 1.4. Revenue Splits

*   **Purpose:** Defines the rules for splitting high-level revenue categories (like VAT or Income Tax) into more granular LEGO pieces.
*   **Source File:** `data/revenue_splits.json`
*   **Status:** **Exists and is functional.**
*   **Pipeline:** Used by the `lego` cache warmer to correctly calculate the baseline amounts for revenue pieces.

## 2. User Experience & Labeling Data

### 2.1. Mission + COFOG Labels (Treemap Categories)

*   **Purpose:** Provides user-friendly names, descriptions, and examples for both COFOG (functional) categories and administrative missions. The treemap currently uses missions; COFOG labels remain for functional views and future toggles.
*   **Source File:** `data/ux_labels.json`
*   **Status:** **Exists and is complete.**
*   **Pipeline:** Read directly by the API to enrich UI components.

### 2.2. Popular Intents (Starting Points)

*   **Purpose:** Provides curated, popular starting points or "intents" for users (e.g., "Hire more nurses"). These are designed as UX shortcuts that seed a target or reform in the builder, simplifying the user journey. While they overlap with the Policy Catalog, they serve a distinct UX purpose: to guide users who don't know where to start, whereas the full catalog is for detailed specification.
*   **Source File:** `data/intents.json`
*   **Status:** **Exists, with a few examples.** Can be expanded.
*   **Pipeline:** Read directly by the API to populate the "Popular Intents" UI component.

## 3. Supporting & Technical Data

### 3.1. COFOG Mapping

*   **Purpose:** Maps French administrative budget codes (missions, programmes) to the international COFOG classification.
*   **Source File:** `data/cofog_mapping.json`
*   **Status:** **Exists and is functional.**
*   **Pipeline:** The canonical mapping logic resides in this JSON file. The dbt warehouse consumes a generated CSV seed and is the preferred source for COFOG aggregates. For GraphQL `allocation(lens: COFOG)`, a warmed Eurostat COFOG share file may be used as a fallback when the warehouse is disabled or incomplete. Direct Python helpers are progressively being limited to the warehouse path as the refactor proceeds (see [Refactoring Plan](./REFACTOR_PLAN.md)).
*   **Provenance:** Warmers now emit sidecar `.meta.json` files with `produced_columns` for CSV artifacts (e.g., PLF mission snapshot, DECP contracts) and key metadata (`extraction_ts`, `row_count`, `source`).

### 3.2. Macroeconomic Assumptions (IRFs)

*   **Purpose:** Stores the Impulse Response Functions (IRFs) used by the "Macro Kernel" to estimate the impact of budget changes on GDP and employment.
*   **Source File:** `data/macro_irfs.json`
*   **Status:** **Exists, with placeholder values.** The model is functional but relies on illustrative data.
*   **Pipeline:** Read by the `runScenario` mutation in the API.

### 3.3. Baseline Projections

*   **Purpose:** Provides the baseline multi-year path for core metrics like GDP, deficit, and debt.
*   **Source Files:** `data/gdp_series.csv`, `data/baseline_deficit_debt.csv`
*   **Status:** **Partially calibrated.** 2026 public deficit updated to **-151.35 Md€** on **2026-02-25** (5.0% of 2026 GDP baseline), aligned with the LFI 2026 target published by budget.gouv.fr on 20/02/2026.
*   **Pipeline:** Read by the `runScenario` mutation to calculate compliance and macro paths. The GraphQL payload now surfaces these series explicitly (`baselineDeficitPath`, `baselineDebtPath`) so clients can reconstruct absolute levels without re-fetching the CSV.

### 3.4. Warmed Snapshots (Eurostat, PLF, DECP)

*   **Mission Credits (`state_budget_mission_{YEAR}.csv`):**
    * 2025 snapshot refreshed from `plf25-depenses-2025-selon-destination` (ODS) on 2025-09-21 producing 46 rows + `.meta.json` with field provenance.
*   **PLF 2026 Ceilings (`plf_2026_plafonds.csv`):**
    * The dedicated warmer `services/api/cache_warm.py:warm_plf_2026_plafonds` normalizes the "plafonds" (ceilings) by mission into a minimal CSV (`year`, `mission_code`, `mission_label`, `plf_ceiling_eur`, `source`) under `data/cache/plf_2026_plafonds.csv` (+ `.meta.json` provenance sidecar).
    * Source selection:
        * By default, it downloads the official **Article 48 LOLF** report PDF (`https://www.budget.gouv.fr/documentation/file-download/30420`) and extracts **Tableau 1bis** (mission ceilings, budget général).
        * The companion XLS (`https://www.budget.gouv.fr/documentation/file-download/30423`) is retained for cross-checking publication provenance but is not used for mission ceiling extraction (performance annex format).
        * A third official cross-check source is available at `https://www.budget.gouv.fr/documentation/file-download/31621` (`PLF26 - Dépenses 2026 selon destination.xls`).
        * You can override via `PLF_2026_PLAFONDS_URL` (URL **or** local path).
        * If download is unavailable, it falls back to the bundled deterministic sample workbook `data/reference/plf_2026_plafonds_sample.xlsx` so CI remains hermetic.
    * **Enacted-law verification path (used for 2026 baseline publication):**
        * Canonical verification script: `tools/verify_lfi_2026_state_b.py`.
        * Canonical reference table: `data/reference/lfi_2026_etat_b_cp_verified.csv` (JO vs AN ÉTAT B, mission-by-mission CP, line refs, match flag).
        * Human audit report: `docs/verification_lfi2026_missions.md`.
    * `warehouse/seeds/plf_2026_plafonds.csv` is generated from this verified enacted table (32 missions) with mission codes aligned to the existing simulation typology (AA/AB/.../RD).
*   **LFI 2026 aggregate receipts/balance (ÉTAT A):**
    * Canonical verification script: `tools/verify_lfi_2026_state_a.py`.
    * Canonical reference table: `data/reference/lfi_2026_etat_a_aggregates_verified.csv` (fiscal/non-fiscal receipts, net resources/charges, general balance).
    * Human audit report: `docs/verification_lfi2026_state_a.md`.
*   **LFSS 2026 social aggregates:**
    * Canonical verification script: `tools/verify_lfss_2026.py`.
    * Canonical reference tables:
      * `data/reference/lfss_2026_branch_equilibre_verified.csv` (branch recettes/dépenses/solde),
      * `data/reference/lfss_2026_asso_pct_verified.csv` (ASSO article liminaire, % PIB).
    * Human audit report: `docs/verification_lfss2026.md`.
*   **APUL 2026 bridge (DGCL-first, source-tagged):**
    * Canonical verification script: `tools/verify_apul_2026.py`.
    * Canonical reference table: `data/reference/apul_2026_verified.csv` (APUL-sensitive treemap blocks with source tags and quality level).
    * Human audit report: `docs/verification_apul2026.md`.
*   **Consolidated voted bundle (`voted_2026_aggregates.json`):**
    * Built by `tools/build_voted_2026_aggregates.py` from verified LFI/LFSS/APUL tables.
    * Contains state/social/local calibration inputs used by the overlay.
*   **Explicit APU targets (`apu_2026_targets.json`):**
    * Built by `tools/build_voted_2026_aggregates.py`.
    * Row-level targets for expenditures and revenues with `source_quality` (`voted`, `observed`, `estimated`) and `subsector` tags (`S1311`, `S1313`, `S1314`).
*   **LEGO Baseline (`lego_baseline_2026.json`):**
    * See §1.2 — warmed for 2026 with Eurostat SDMX sources, then overlaid with voted 2026 LFI/LFSS targets via `tools/apply_voted_2026_to_lego_baseline.py`.
    * Overlay metadata is recorded under `meta.voted_2026_overlay` (source bundle path, mappings, excluded mission codes, execution timestamp, and quality checks under `meta.voted_2026_overlay.quality`).
*   **Eurostat COFOG Shares (`eu_cofog_shares_{YEAR}.json`, `eu_cofog_subshares_{YEAR}.json`):**
    * 2026 FR/DE/IT shares and subshares refreshed 2025-09-22 via `eurostat-cofog` and `eurostat-cofog-sub` warmers.
*   **Procurement Contracts (`procurement_contracts_{YEAR}.csv`):**
    * 2024 extract warmed 2025-09-22 directly from ODS (`decp-v3-marches-valides`) with 10k-record pagination (481 unique 2024 contracts retained after dedupe).
*   **Macro Series (`macro_series_FR.json`):**
    * INSEE warmers rerun 2025-09-22 with `data/macro_series_config.json`; metadata captures dataset ids and extraction timestamp.
